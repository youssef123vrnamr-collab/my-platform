<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>فلك العالمي | النسخة السحابية</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f0a1a">
    <meta name="apple-mobile-web-app-title" content="فلك العالمي">
    
    <link rel="manifest" href="manifest.json">
    
    <!-- السكريبتات الخارجية -->
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ========== الأنماط الأساسية (كما هي مع إضافة أنماط جديدة للامتحانات) ========== */
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f0a1a;
            --card: #1a1025;
            --ai-color: #06b6d4;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #050308 0%, #0f0a1a 50%, #1a1a3e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        /* إخفاء شريط العنوان */
        body::before {
            content: '';
            position: fixed;
            top: -100px;
            left: 0;
            width: 100%;
            height: 100px;
            background: #0f0a1a;
            z-index: 99999;
        }
        
        .bg-animation {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1; overflow: hidden;
        }
        
        .nebula {
            position: absolute;
            width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(60px);
            animation: float 20s infinite ease-in-out;
        }
        
        .nebula:nth-child(1) { top: -300px; right: -300px; }
        .nebula:nth-child(2) { bottom: -300px; left: -300px; background: radial-gradient(circle, rgba(236, 72, 153, 0.1) 0%, transparent 70%); animation-delay: -10s; }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }
        
        .loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #050308;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }
        
        .loader.hidden { opacity: 0; pointer-events: none; }
        
        .loader-ring {
            width: 120px; height: 120px;
            border: 4px solid transparent;
            border-top-color: #6366f1;
            border-right-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loader-text {
            margin-top: 2rem;
            font-size: 1.3rem;
            color: #6366f1;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        
        .navbar {
            background: rgba(26, 16, 37, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(99, 102, 241, 0.3);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            padding-top: max(1rem, env(safe-area-inset-top));
        }
        
        .brand { display: flex; align-items: center; gap: 1rem; }
        
        .brand-icon {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, #6366f1, #ec4899);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
            animation: glow 3s infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 10px 40px rgba(236, 72, 153, 0.6); }
        }
        
        .brand-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .brand-text p { font-size: 0.85rem; color: #888; }
        
        .nav-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(99, 102, 241, 0.6); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-ghost { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #64748b, #475569); color: white; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        
        .hero {
            text-align: center;
            padding: 4rem 2rem;
            margin-bottom: 3rem;
        }
        
        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #10b981;
            margin-bottom: 1.5rem;
        }
        
        .hero h2 { font-size: 3rem; font-weight: 900; margin-bottom: 1rem; }
        .hero h2 span { background: linear-gradient(135deg, #6366f1, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero p { font-size: 1.2rem; color: #aaa; max-width: 600px; margin: 0 auto; }
        
        .upload-zone {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
            border: 2px dashed rgba(99, 102, 241, 0.5);
            border-radius: 25px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 3rem;
            display: none;
            position: relative;
            overflow: hidden;
        }
        
        .upload-zone.active { display: block; animation: fadeInUp 0.5s; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .upload-icon {
            width: 100px; height: 100px;
            background: linear-gradient(135deg, #6366f1, #ec4899);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1.5rem;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.4);
        }
        
        .upload-icon:hover { transform: scale(1.1) rotate(10deg); }
        
        .upload-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5); }
        
        .upload-info {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            font-size: 0.9rem;
            color: #888;
        }
        
        .cloudinary-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(52, 73, 94, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            color: #3498db;
        }
        
        .resume-notification {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(236, 72, 153, 0.2));
            backdrop-filter: blur(10px);
            border: 1px solid #6366f1;
            border-radius: 20px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            display: none;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            animation: slideDown 0.5s;
        }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .resume-info { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .resume-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #6366f1, #ec4899); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .resume-text h4 { font-size: 1.2rem; margin-bottom: 0.2rem; }
        .resume-text p { color: #aaa; font-size: 0.9rem; }
        .resume-actions { display: flex; gap: 0.75rem; }
        .resume-btn { background: #6366f1; border: none; color: white; padding: 0.6rem 1.5rem; border-radius: 30px; font-family: 'Cairo', sans-serif; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 0.5rem; }
        .resume-btn:hover { background: #4f52e0; transform: scale(1.05); }
        .dismiss-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #ccc; padding: 0.6rem 1.2rem; border-radius: 30px; font-family: 'Cairo', sans-serif; cursor: pointer; transition: 0.3s; }
        .dismiss-btn:hover { background: rgba(255,255,255,0.1); }
        
        .videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }
        
        .video-card {
            background: #1a1025;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.4s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .video-card:hover {
            transform: translateY(-10px);
            border-color: #6366f1;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        
        .video-thumbnail {
            position: relative;
            height: 220px;
            background: linear-gradient(135deg, #1a1a3e 0%, #0f0f23 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: #6366f1;
            overflow: hidden;
        }
        
        .video-thumbnail .bg-gif {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        .video-thumbnail::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.5) 100%);
            z-index: 2;
        }
        
        .play-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 3;
        }
        
        .video-card:hover .play-overlay { opacity: 1; }
        
        .play-btn {
            width: 80px; height: 80px;
            background: linear-gradient(135deg, #6366f1, #ec4899);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .video-info { 
            padding: 2.5rem 2rem 3rem 2rem; 
            flex: 1; 
            background: linear-gradient(to top, rgba(26,16,37,0.98) 0%, rgba(26,16,37,0.9) 100%);
            position: relative;
            z-index: 4;
            margin-top: -60px;
            border-radius: 20px 20px 0 0;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        .video-title { 
            font-size: 1.5rem; 
            font-weight: 700; 
            margin-bottom: 1.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            line-height: 1.8;
        }
        
        .video-description {
            color: #ccc;
            font-size: 1.1rem;
            margin-bottom: 2rem;
            line-height: 2.2;
            max-height: none;
            overflow: visible;
            text-overflow: clip;
            display: block;
            -webkit-line-clamp: unset;
            -webkit-box-orient: unset;
            flex: 1;
            padding-bottom: 1.5rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .video-meta { 
            color: #aaa; 
            font-size: 0.95rem; 
            display: flex; 
            gap: 1.5rem; 
            flex-wrap: wrap; 
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .video-duration {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            color: white;
            z-index: 5;
        }
        
        .gif-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(236, 72, 153, 0.9);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 5;
        }
        
        .empty-state {
            text-align: center;
            padding: 6rem 2rem;
            color: #666;
        }
        
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 2rem;
        }
        
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-content {
            background: #1a1025;
            border-radius: 25px;
            width: 100%;
            max-width: 1000px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header-left { display: flex; align-items: center; gap: 1rem; }
        .modal-close {
            width: 40px; height: 40px;
            border: none;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .modal-close:hover { background: rgba(239, 68, 68, 0.4); transform: rotate(90deg); }
        .modal-share {
            width: 40px; height: 40px;
            border: none;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
        }
        .modal-share:hover { background: rgba(16, 185, 129, 0.4); transform: scale(1.1); }
        .modal-body { padding: 0; }
        .video-player { width: 100%; height: auto; max-height: 70vh; border-radius: 0 0 25px 25px; }
        
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1025;
            border: 1px solid #6366f1;
            padding: 1rem 2rem;
            border-radius: 15px;
            display: none;
            z-index: 10001;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateX(-50%) translateY(100px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
        .toast.show { display: block; }
        
        .cloudinary-thumbnail { width: 100%; height: 100%; object-fit: cover; }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .edit-title-btn {
            position: absolute;
            top: 10px;
            right: 80px;
            background: #f59e0b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .exam-btn {
            position: absolute;
            top: 10px;
            right: 150px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        /* زر حذف الامتحان (جديد) */
        .delete-exam-btn {
            position: absolute;
            top: 10px;
            right: 220px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .video-card:hover .delete-btn,
        .video-card:hover .edit-title-btn,
        .video-card:hover .exam-btn,
        .video-card:hover .delete-exam-btn { opacity: 1; }
        
        .delete-exam-btn:hover { background: #b91c1c; transform: scale(1.05); }
        
        /* أنماط تحسين حقول الإدخال في نموذج الامتحان */
        .question-form input,
        .question-form input[type="text"],
        .option-input-group input {
            background: #2a1a35 !important;
            color: #fff !important;
            border: 2px solid #6366f1 !important;
            font-size: 1.1rem !important;
            padding: 0.75rem !important;
            border-radius: 10px !important;
            width: 100%;
            transition: 0.3s;
        }
        .question-form input:focus,
        .option-input-group input:focus {
            border-color: #ec4899 !important;
            box-shadow: 0 0 10px rgba(236,72,153,0.5);
            outline: none;
        }
        .question-form input::placeholder,
        .option-input-group input::placeholder {
            color: #aaa;
            opacity: 0.8;
        }
        
        /* زر تصحيح الامتحان (للمشرف) */
        .correction-btn-card {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            width: 100%;
            justify-content: center;
        }
        .correction-btn-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245,158,11,0.4);
        }
        
        /* باقي الأنماط (كما هي من الكود الأصلي) */
        /* ... (لن نكرر كل الأنماط لتقصير الرد، ولكن يجب تضمينها في الملف الفعلي) ... */
        /* ملاحظة: في التطبيق الفعلي، يجب وضع جميع الأنماط السابقة هنا */
    </style>
</head>
<body>
    <div class="bg-animation">
        <div class="nebula"></div>
        <div class="nebula"></div>
    </div>
    
    <div class="loader" id="loader">
        <div class="loader-ring"></div>
        <div class="loader-text">جاري الاتصال...</div>
    </div>
    
    <nav class="navbar">
        <div class="brand">
            <div class="brand-icon"><i class="fas fa-planet-ringed"></i></div>
            <div class="brand-text">
                <h1>فلك العالمي</h1>
                <p>النسخة السحابية ☁️</p>
            </div>
        </div>
        <div class="nav-actions">
            <button class="btn btn-ghost" id="adminBtn" onclick="showLogin()">
                <i class="fas fa-lock"></i> دخول المشرف
            </button>
            <button class="btn btn-danger" id="logoutBtn" onclick="logout()" style="display: none;">
                <i class="fas fa-sign-out-alt"></i> خروج
            </button>
            <button class="maintenance-btn" id="maintenanceBtn" onclick="openMaintenanceModal()" style="display: none;" title="تحديث المحتوى">
                <i class="fas fa-tools"></i> تحديث المحتوى
            </button>
        </div>
    </nav>
    
    <div class="maintenance-overlay" id="maintenanceOverlay">
        <div class="maintenance-icon"><i class="fas fa-tools"></i></div>
        <div class="maintenance-title">تحديث المحتوى</div>
        <div class="maintenance-message" id="maintenanceMessage">جاري تحديث المنصة، يرجى الانتظار قليلاً...</div>
        <div class="maintenance-timer" id="maintenanceTimer">
            <div class="timer-item">
                <div class="timer-value" id="timerHours">00</div>
                <div class="timer-label">ساعة</div>
            </div>
            <div class="timer-item">
                <div class="timer-value" id="timerMinutes">00</div>
                <div class="timer-label">دقيقة</div>
            </div>
            <div class="timer-item">
                <div class="timer-value" id="timerSeconds">00</div>
                <div class="timer-label">ثانية</div>
            </div>
        </div>
        <div class="maintenance-datetime" id="maintenanceEndTime"></div>
        <button class="maintenance-cancel" id="cancelMaintenanceBtn" onclick="cancelMaintenance()">
            <i class="fas fa-times"></i> إلغاء التحديث
        </button>
    </div>
    
    <div class="container">
        <div class="hero">
            <div class="hero-badge"><i class="fas fa-cloud"></i> متصل بـ Cloudinary</div>
            <h2>اكتشف أسرار <span>الكون</span></h2>
            <p>أي فيديو ترفعه يظهر فوراً لجميع الزوار حول العالم عبر Cloudinary!</p>
        </div>
        
        <!-- الأزرار العلوية للمشرف -->
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: center;">
            <button class="set-admins-btn" id="setAdminsBtn" onclick="openSetAdminsModal()" style="display: none;">
                <i class="fas fa-users-cog"></i> تحديد المشرفين
            </button>
            <button class="teach-ai-circle-btn" id="teachAICircleBtn" onclick="openTeachAICircleModal()" title="تعليم الذكاء الاصطناعي" style="display: none;">
                <i class="fas fa-robot"></i>
            </button>
            <button class="btn btn-secondary" id="examResultsBtn" onclick="openExamResultsModal()" style="display: none;">
                <i class="fas fa-clipboard-list"></i> نتائج الامتحانات
            </button>
        </div>
        
        <div class="storage-bar-container" id="storageBar" style="display: none;">
            <div class="storage-header">
                <div class="storage-title">
                    <i class="fas fa-hdd" style="color: #6366f1;"></i>
                    مساحة التخزين
                </div>
                <div class="storage-stats">
                    <span id="usedSpace">0 GB</span> / <span id="totalSpace">25 GB</span>
                    (<span class="storage-percentage" id="percentage">0%</span>)
                </div>
            </div>
            <div class="storage-bar-wrapper">
                <div class="storage-bar low" id="storageProgress" style="width: 0%;"></div>
            </div>
            <div class="storage-footer">
                <span id="remainingText">المتبقي: 25 GB</span>
                <span id="videosCount">0 فيديو</span>
            </div>
        </div>
        
        <div class="upload-zone" id="uploadZone">
            <div class="upload-icon" onclick="openCloudinaryWidget()">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h3>رفع فيديو جديد</h3>
            <p>استخدم واجهة Cloudinary لرفع الفيديوهات بشكل آمن وسريع</p>
            <button class="upload-btn" onclick="openCloudinaryWidget()">
                <i class="fas fa-plus"></i> فتح واجهة الرفع
            </button>
            
            <div class="upload-progress-container" id="uploadProgressContainer">
                <div class="upload-progress-header">
                    <span id="uploadProgressText">جاري الرفع...</span>
                    <span id="uploadProgressPercent">0%</span>
                </div>
                <div class="upload-progress-bar">
                    <div class="upload-progress-fill" id="uploadProgressFill" style="width: 0%;"></div>
                </div>
                <div class="upload-stats">
                    <span id="uploadSpeed">0 MB/s</span>
                    <span id="uploadTimeRemaining">--:-- متبقي</span>
                </div>
            </div>
            
            <div class="upload-info">
                <i class="fas fa-info-circle"></i> 
                يتم الرفع مباشرة إلى Cloudinary | يدعم الفيديوهات حتى 100 ميجابايت
                <div class="upload-speed-indicator">
                    <i class="fas fa-bolt"></i> رفع سريع (10MB/chunk)
                </div>
            </div>
            
            <div class="cloudinary-badge">
                <i class="fas fa-shield-alt"></i>
                محمي بواسطة Cloudinary Upload Widget
            </div>
        </div>

        <div class="resume-notification" id="resumeNotification">
            <div class="resume-info">
                <div class="resume-icon"><i class="fas fa-history"></i></div>
                <div class="resume-text">
                    <h4 id="resumeVideoTitle">عنوان الفيديو</h4>
                    <p id="resumeTimeDisplay">توقفت عند: 0:00</p>
                </div>
            </div>
            <div class="resume-actions">
                <button class="resume-btn" onclick="resumeWatching()"><i class="fas fa-play"></i> استئناف</button>
                <button class="dismiss-btn" onclick="dismissResume()"><i class="fas fa-times"></i> تجاهل</button>
            </div>
        </div>
        
        <h3 style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
            <i class="fas fa-play-circle" style="color: #ec4899;"></i>
            مكتبة الفيديوهات المشتركة
            <span id="videoCount" style="margin-right: auto; background: rgba(99,102,241,0.2); padding: 0.3rem 1rem; border-radius: 20px; font-size: 0.9rem;">0 فيديو</span>
        </h3>
        
        <div class="videos-grid" id="videosContainer"></div>
        
        <div class="empty-state" id="emptyState">
            <i class="fas fa-satellite" style="font-size: 6rem; margin-bottom: 2rem;"></i>
            <h3>المكتبة فارغة</h3>
            <p>ادخل كمشرف لرفع أول فيديو!</p>
        </div>
    </div>
    
    <!-- زرار محادثة الذكاء الاصطناعي (للجميع) -->
    <button class="ai-chat-btn" id="aiChatBtn" onclick="openAIChat()" title="تحدث مع الذكاء الاصطناعي">
        <i class="fas fa-robot"></i>
    </button>
    
    <!-- زرار معرفة النتيجة (للجميع) -->
    <button class="check-result-btn" id="checkResultBtn" onclick="openCheckResultModal()" title="معرفة نتيجة الامتحان">
        <i class="fas fa-poll"></i> معرفة النتيجة
    </button>
    
    <!-- زرار الدردشة -->
    <button class="chat-btn" onclick="openChat()" id="chatBtn">
        <i class="fas fa-comments"></i>
        <span class="notification-badge" id="chatBadge" style="display: none;">0</span>
    </button>
    
    <!-- نافذة محادثة الذكاء الاصطناعي -->
    <div class="modal chat-modal" id="aiChatModal">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-avatar" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="chat-header-text">
                        <h3>مساعد فلك الذكي</h3>
                        <p><span class="online-dot"></span> متصل الآن</p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn" onclick="closeAIChat()" title="إغلاق">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="chat-messages" id="aiChatMessages"></div>
            <div class="chat-input-area">
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea class="chat-input" id="aiChatInput" placeholder="اكتب سؤالك هنا..." rows="1" onkeypress="handleAIKeyPress(event)"></textarea>
                    </div>
                    <button class="chat-send-btn" onclick="sendAIMessage()" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal chat-modal" id="chatModal">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-avatar"><i class="fas fa-users"></i></div>
                    <div class="chat-header-text">
                        <h3>دردشة فلك العالمي</h3>
                        <p><span class="online-dot"></span> <span id="onlineCount">جاري التحميل...</span></p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn call-btn" onclick="startVoiceCall()" title="مكالمة صوتية">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="chat-action-btn" onclick="closeChat()" title="إغلاق">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <div class="recording-indicator" id="recordingIndicator">
                    <span class="recording-dot"></span>
                    <span>جاري التسجيل... <span id="recordingTime">0:00</span></span>
                </div>
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <button class="chat-tool-btn" onclick="document.getElementById('imageInput').click()" title="إرسال صورة">
                            <i class="fas fa-image"></i>
                        </button>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="sendImage(this)">
                        <button class="chat-tool-btn" id="recordBtn" onclick="toggleRecording()" title="رسالة صوتية">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <textarea class="chat-input" id="messageInput" placeholder="اكتب رسالتك..." rows="1" onkeypress="handleKeyPress(event)"></textarea>
                    </div>
                    <button class="chat-send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="videoModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h3 id="modalTitle"><i class="fas fa-play-circle"></i> <span>عنوان الفيديو</span></h3>
                    <button class="modal-share" onclick="shareCurrentTime()" title="مشاركة هذه اللحظة"><i class="fas fa-share-alt"></i></button>
                </div>
                <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <video class="video-player" id="videoPlayer" controls playsinline></video>
            </div>
        </div>
    </div>
    
    <div class="modal" id="loginModal" style="background: rgba(0,0,0,0.95);">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-lock"></i> دخول المشرف</h3>
                <button class="modal-close" onclick="closeLogin()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <input type="password" id="passwordInput" placeholder="اكتب كلمة المرور هنا..." 
                       style="width: 100%; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: 'Cairo'; margin-bottom: 1rem; font-size: 1.1rem; text-align: center;"
                       onkeypress="if(event.key==='Enter')doLogin()">
                <button class="btn btn-primary" style="width: 100%;" onclick="doLogin()">
                    <i class="fas fa-sign-in-alt"></i> دخول
                </button>
                <button onclick="closeLogin()" style="width: 100%; background: transparent; border: none; color: #888; margin-top: 1rem; cursor: pointer; font-family: 'Cairo';">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="adminPasswordModal" style="background: rgba(0,0,0,0.95);">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-users-cog"></i> صلاحية تحديد المشرفين</h3>
                <button class="modal-close" onclick="closeAdminPasswordModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p style="margin-bottom:1rem; color:#aaa;">هذه الصلاحية للمشرف الرئيسي فقط</p>
                <input type="password" id="adminPasswordInput" placeholder="كلمة المرور الخاصة" 
                       style="width: 100%; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: 'Cairo'; margin-bottom: 1rem; font-size: 1.1rem; text-align: center;"
                       onkeypress="if(event.key==='Enter')verifyAdminPassword()">
                <button class="btn btn-primary" style="width: 100%;" onclick="verifyAdminPassword()">
                    <i class="fas fa-check"></i> تحقق
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="setAdminsModal">
        <div class="modal-content description-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-users"></i> تحديد عدد المشرفين</h3>
                <button class="modal-close" onclick="closeSetAdminsModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="form-group">
                    <label>عدد المشرفين المسموح به</label>
                    <input type="number" id="adminCountInput" min="1" max="10" value="1" style="width: 100%; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: 'Cairo'; font-size: 1.1rem;">
                </div>
                <button class="btn btn-success" style="width: 100%;" onclick="saveAdminCount()">
                    <i class="fas fa-save"></i> حفظ
                </button>
            </div>
        </div>
    </div>
    
    <!-- نافذة تعليم الذكاء الاصطناعي (للمشرف فقط) -->
    <div class="modal" id="teachAICircleModal">
        <div class="modal-content description-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-robot" style="color: #06b6d4;"></i> تعليم الذكاء الاصطناعي</h3>
                <button class="modal-close" onclick="closeTeachAICircleModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p style="margin-bottom: 1.5rem; color: #aaa;">
                    أضف أسئلة وأجوبة جديدة. عندما يسأل أحد الـ AI سؤالاً مشابهاً، سيرد بالإجابة المعلمة.
                </p>
                <div class="form-group">
                    <label><i class="fas fa-question-circle" style="color: #06b6d4;"></i> السؤال</label>
                    <input type="text" id="aiQuestionInput" placeholder="مثال: ما هي السوائل؟" dir="rtl">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-comment-dots" style="color: #10b981;"></i> الإجابة</label>
                    <textarea id="aiAnswerInput" placeholder="اكتب الإجابة هنا..." rows="4" style="min-height: 120px;"></textarea>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 1.5rem;" onclick="saveAIKnowledge()">
                    <i class="fas fa-save"></i> حفظ المعرفة
                </button>
                <h4 style="margin: 1.5rem 0 1rem 0; color: #fff;">
                    <i class="fas fa-list" style="color: #8b5cf6;"></i> المعارف المخزنة
                </h4>
                <div class="correction-list" id="aiKnowledgeList" style="max-height: 250px; overflow-y: auto;">
                    <p style="text-align: center; color: #888; padding: 2rem;">جاري التحميل...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نافذة إنشاء الامتحان (للمشرف فقط) -->
    <div class="modal" id="createExamModal">
        <div class="modal-content exam-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-clipboard-list" style="color: #10b981;"></i> إنشاء امتحان للفيديو</h3>
                <button class="modal-close" onclick="closeCreateExamModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="examQuestionsContainer"></div>
                <button class="add-question-btn" onclick="addQuestionForm()">
                    <i class="fas fa-plus"></i> إضافة سؤال جديد
                </button>
                <button class="btn btn-success" style="width: 100%;" onclick="saveExam()">
                    <i class="fas fa-save"></i> حفظ الامتحان
                </button>
            </div>
        </div>
    </div>
    
    <!-- نافذة الامتحان للطلاب -->
    <div class="modal" id="studentExamModal">
        <div class="modal-content student-exam-modal">
            <div class="modal-header">
                <h3><i class="fas fa-edit" style="color: #6366f1;"></i> <span id="studentExamTitle">امتحان الفيديو</span></h3>
                <button class="modal-close" onclick="closeStudentExamModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="studentNameEntry" class="name-entry-form">
                    <h3>أدخل اسمك الكامل</h3>
                    <input type="text" id="studentExamNameInput" placeholder="الاسم الكامل..." maxlength="50">
                    <button class="btn btn-primary" onclick="startStudentExam()">
                        <i class="fas fa-play"></i> بدء الامتحان
                    </button>
                </div>
                <div id="studentExamQuestions" style="display: none;">
                    <div class="exam-progress">
                        <span id="currentQuestionNum">1</span>
                        <div class="exam-progress-bar">
                            <div class="exam-progress-fill" id="examProgressFill" style="width: 0%;"></div>
                        </div>
                        <span id="totalQuestionsNum">5</span>
                    </div>
                    <div id="examQuestionsList"></div>
                    <button class="btn btn-success" style="width: 100%; margin-top: 1.5rem;" onclick="submitExam()">
                        <i class="fas fa-paper-plane"></i> إرسال الامتحان
                    </button>
                </div>
                <div id="studentExamResult" class="result-display" style="display: none;">
                    <div class="result-score" id="resultScore">0/0</div>
                    <div class="result-message" id="resultMessage"></div>
                    <div class="result-details" id="resultDetails"></div>
                    <button class="btn btn-primary" style="margin-top: 1.5rem;" onclick="closeStudentExamModal()">
                        <i class="fas fa-check"></i> تم
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نافذة نتائج الامتحانات (للمشرف) -->
    <div class="modal" id="examResultsModal">
        <div class="modal-content results-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-bar" style="color: #f59e0b;"></i> نتائج الامتحانات</h3>
                <button class="modal-close" onclick="closeExamResultsModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="margin-bottom: 1rem;">
                    <label style="color: #aaa; margin-bottom: 0.5rem; display: block;">اختر الفيديو:</label>
                    <select id="resultsVideoSelect" onchange="loadExamResults()" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-family: 'Cairo';">
                        <option value="">-- اختر فيديو --</option>
                    </select>
                </div>
                <div id="examResultsContainer">
                    <p style="text-align: center; color: #888; padding: 3rem;">اختر فيديو لعرض نتائجه</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نافذة معرفة النتيجة -->
    <div class="modal" id="checkResultModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-search" style="color: #f59e0b;"></i> معرفة نتيجة الامتحان</h3>
                <button class="modal-close" onclick="closeCheckResultModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="form-group">
                    <label>اختر الفيديو:</label>
                    <select id="checkResultVideoSelect" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-family: 'Cairo'; margin-bottom: 1rem;">
                        <option value="">-- اختر فيديو --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>أدخل اسمك كما أدخلته في الامتحان:</label>
                    <input type="text" id="checkResultNameInput" placeholder="الاسم الكامل..." style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-family: 'Cairo'; margin-bottom: 1.5rem;">
                </div>
                <button class="btn btn-warning" style="width: 100%;" onclick="searchExamResult()">
                    <i class="fas fa-search"></i> بحث عن النتيجة
                </button>
                <div id="checkResultDisplay" style="margin-top: 1.5rem; display: none;"></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="descriptionModal">
        <div class="modal-content description-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> تفاصيل الفيديو</h3>
                <button class="modal-close" onclick="closeDescriptionModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="form-group">
                    <label>عنوان الفيديو</label>
                    <input type="text" id="videoTitleInput" placeholder="أدخل عنوان الفيديو" value="">
                </div>
                <div class="form-group">
                    <label>وصف الفيديو <span id="descCharCount" style="color: #888; font-size: 0.85rem;">(0 / 5000 حرف)</span></label>
                    <textarea id="videoDescriptionInput" placeholder="اكتب وصفاً مختصراً للفيديو..." maxlength="5000"></textarea>
                </div>
                <button class="btn btn-success" style="width: 100%;" onclick="saveVideoWithDescription()">
                    <i class="fas fa-save"></i> حفظ الفيديو
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="editVideoModal">
        <div class="modal-content description-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> تعديل بيانات الفيديو</h3>
                <button class="modal-close" onclick="closeEditVideoModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="form-group">
                    <label>عنوان الفيديو</label>
                    <input type="text" id="editVideoTitleInput" placeholder="أدخل عنوان الفيديو" style="width: 100%; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: 'Cairo'; font-size: 1.1rem;">
                </div>
                <div class="form-group">
                    <label>وصف الفيديو <span id="editDescCharCount" style="color: #888; font-size: 0.85rem;">(0 / 5000 حرف)</span></label>
                    <textarea id="editVideoDescriptionInput" placeholder="اكتب وصفاً مختصراً للفيديو..." maxlength="5000" style="width: 100%; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: 'Cairo'; font-size: 1.1rem; min-height: 200px; resize: vertical;"></textarea>
                </div>
                <button class="btn btn-success" style="width: 100%;" onclick="saveVideoEdit()">
                    <i class="fas fa-save"></i> حفظ التعديلات
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="maintenanceModal">
        <div class="modal-content description-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-tools"></i> تحديث المحتوى</h3>
                <button class="modal-close" onclick="closeMaintenanceModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p style="margin-bottom: 1.5rem; color: #aaa;">حدد المدة التي تريد تعطيل المنصة خلالها للتحديث. سيظهر للزوار عداد تنازلي مع صوت تكتكة.</p>
                <div class="form-group">
                    <label>المدة (بالدقائق)</label>
                    <input type="number" id="maintenanceMinutes" min="1" max="60" value="5" style="width: 100%; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: 'Cairo'; font-size: 1.1rem;">
                </div>
                <div class="form-group">
                    <label>رسالة التحديث (اختياري)</label>
                    <textarea id="maintenanceMessageInput" placeholder="اكتب رسالة للزوار..." style="width: 100%; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: 'Cairo'; font-size: 1.1rem; min-height: 100px;"></textarea>
                </div>
                <button class="btn btn-warning" style="width: 100%;" onclick="startMaintenance()">
                    <i class="fas fa-play"></i> بدء التحديث
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="nameModal">
        <div class="modal-content name-modal-content">
            <div class="name-modal-icon"><i class="fas fa-user-astronaut"></i></div>
            <h2>مرحباً بك في فلك العالمي</h2>
            <p>أدخل اسمك للانضمام إلى الدردشة</p>
            <div class="name-input-group">
                <input type="text" class="name-input" id="userNameInput" placeholder="اسمك..." maxlength="20">
            </div>
            <button class="btn btn-primary" style="width: 100%; padding: 1rem;" onclick="saveUserName()">
                <i class="fas fa-check"></i> دخول
            </button>
        </div>
    </div>
    
    <div class="modal" id="callModal">
        <div class="modal-content call-modal-content">
            <div class="call-avatar"><i class="fas fa-users"></i></div>
            <div class="call-status" id="callStatus">مكالمة جماعية</div>
            <div class="call-timer" id="callTimer">00:00</div>
            <div class="call-actions">
                <button class="call-action mute" id="muteBtn" onclick="toggleMute()">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="call-action end" onclick="endCall()">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="image-viewer" id="imageViewer" onclick="closeImageViewer()">
        <button class="image-viewer-close" onclick="closeImageViewer()">
            <i class="fas fa-times"></i>
        </button>
        <img src="" alt="صورة" id="viewerImage">
    </div>
    
    <div class="toast" id="toast">تم بنجاح</div>

    <script>
        // ==================== بداية الكود المحسن مع تعديلات الامتحانات ====================
        
        // ** حل طارئ: إخفاء شاشة التحميل بعد 5 ثواني مهما حدث **
        setTimeout(() => {
            const loader = document.getElementById('loader');
            if (loader) loader.classList.add('hidden');
        }, 5000);

        // عرض الأخطاء في console
        window.onerror = function(msg, url, line, col, error) {
            console.error('🔥 خطأ عام:', msg, 'at line', line);
            return true;
        };

        // إعدادات Cloudinary
        const CLOUDINARY_CONFIG = {
            cloudName: 'ds4wy90er',
            uploadPreset: 'falak_upload',
            apiKey: '462193620740'
        };

        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCAgFi4D9hwtuK391fLsbnDuh5AtTDIHKU",
            authDomain: "planning-with-ai-390af.firebaseapp.com",
            projectId: "planning-with-ai-390af",
            storageBucket: "planning-with-ai-390af.firebasestorage.app",
            messagingSenderId: "601755857673",
            appId: "1:601755857673:web:b9d7d63e13035412a819d8"
        };

        // تهيئة Firebase مع معالجة الأخطاء
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('✅ Firebase initialized');
        } catch (e) {
            console.error('❌ فشل تهيئة Firebase:', e);
            db = null;
        }

        // متغيرات عامة
        const ADMIN_PASS = "@@@&&&((()))";
        const SUPER_ADMIN_PASS = "1#3_5-7(9/0";
        const MAX_VIDEO_SIZE = 100 * 1024 * 1024;
        const CHUNK_SIZE = 10 * 1024 * 1024;
        const MAX_STORAGE = 25 * 1024 * 1024 * 1024;
        let isAdmin = false;
        let isSuperAdmin = false;
        let videos = [];
        let uploadWidget = null;
        let unsubscribe = null;
        let pendingVideoInfo = null;
        let uploadStartTime = 0;
        let lastUploadedBytes = 0;
        let lastTime = 0;
        let currentEditVideoId = null;
        let maintenanceUnsubscribe = null;
        let maintenanceTimerInterval = null;
        let tickInterval = null;
        let maintenanceEndTime = null;
        let currentUser = null;
        let chatUnsubscribe = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let localStream = null;
        let callTimer = null;
        let callSeconds = 0;
        let unreadMessages = 0;
        let isRecording = false;
        let currentAudio = null;
        let currentAudioBtn = null;
        let userPresenceRef = null;
        let onlineUsersRef = db ? db.collection('online_users') : null;
        let onlineUnsubscribe = null;
        let presenceInterval = null;
        let aiKnowledgeBase = [];
        let aiKnowledgeUnsubscribe = null;

        // ========== متغيرات الامتحانات ==========
        let currentExamVideoId = null;
        let examQuestions = [];
        let currentExamData = null;
        let studentAnswers = {};
        let currentQuestionIndex = 0;

        // دالة لإخفاء شاشة التحميل يدوياً
        function hideLoader() {
            const loader = document.getElementById('loader');
            if (loader) loader.classList.add('hidden');
        }

        // التحقق من وجود Firebase قبل استخدامه
        function isFirebaseReady() {
            return db !== null && typeof db !== 'undefined';
        }

        // دالة آمنة للاستماع إلى الفيديوهات
        function listenToVideos() {
            if (!isFirebaseReady()) {
                console.warn('⚠️ Firebase غير متاح، لن يتم تحميل الفيديوهات');
                renderVideos();
                hideLoader();
                return;
            }
            if (unsubscribe) unsubscribe();
            unsubscribe = db.collection('videos').orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    videos = [];
                    snapshot.forEach(doc => {
                        let v = doc.data();
                        v.id = doc.id;
                        videos.push(v);
                    });
                    renderVideos();
                    updateStorageBar();
                    checkForResume();
                    checkUrlForShare();
                    hideLoader();
                }, error => {
                    console.error('❌ خطأ في تحميل الفيديوهات:', error);
                    hideLoader();
                    showToast('⚠️ تعذر تحميل الفيديوهات، لكن يمكنك استخدام باقي الميزات');
                });
        }

        // دالة آمنة للاستماع إلى حالة الصيانة
        function listenToMaintenance() {
            if (!isFirebaseReady()) return;
            maintenanceUnsubscribe = db.collection('system').doc('maintenance')
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.status === 'maintenance') {
                            maintenanceEndTime = data.endTime ? data.endTime.toDate() : null;
                            showMaintenanceScreen(data.message || 'جاري التحديث...', maintenanceEndTime);
                        } else {
                            hideMaintenanceScreen();
                        }
                    } else {
                        hideMaintenanceScreen();
                    }
                }, error => {
                    console.error('Error listening to maintenance:', error);
                });
        }

        // بدء التطبيق بعد تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM جاهز');
            listenToVideos();
            listenToMaintenance();
            loadAIKnowledgeFromFirebase();
            initCloudinaryWidget();
            checkUrlForShare();
            checkSavedAdmin();
            setTimeout(hideLoader, 3000);
        });

        // دالة التحقق من المشرف المخزن
        function checkSavedAdmin() {
            const savedAdmin = localStorage.getItem('falak_admin');
            if (savedAdmin === 'true') {
                isAdmin = true;
                document.getElementById('uploadZone')?.classList.add('active');
                document.getElementById('adminBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'flex';
                document.getElementById('maintenanceBtn').style.display = 'flex';
                document.getElementById('setAdminsBtn').style.display = 'inline-flex';
                document.getElementById('teachAICircleBtn').style.display = 'inline-flex';
                document.getElementById('examResultsBtn').style.display = 'inline-flex';
                updateStorageBar();
                renderVideos();
                loadAIKnowledgeFromFirebase();
            }
        }

        // ========== دالة renderVideos المعدلة (مع إضافة أزرار الامتحانات الجديدة) ==========
        function renderVideos() {
            const container = document.getElementById('videosContainer');
            const emptyState = document.getElementById('emptyState');
            const videoCountSpan = document.getElementById('videoCount');
            if (!container) return;
            if (videos.length === 0) {
                container.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                if (videoCountSpan) videoCountSpan.textContent = '0 فيديو';
                return;
            }
            if (emptyState) emptyState.style.display = 'none';
            if (videoCountSpan) videoCountSpan.textContent = videos.length + ' فيديو';
            
            container.innerHTML = videos.map((video, index) => {
                const duration = video.duration ? formatDuration(video.duration) : '';
                let bgSource = video.gif;
                let isGif = true;
                if (!bgSource) { bgSource = video.thumbnail; isGif = false; }
                if (!bgSource && video.publicId) { bgSource = 'https://res.cloudinary.com/' + CLOUDINARY_CONFIG.cloudName + '/video/upload/so_0,eo_3,w_400,h_225,c_fill,f_gif/' + video.publicId + '.gif'; isGif = true; }
                else if (!bgSource && video.url) {
                    const match = video.url.match(/\/video\/upload\/(?:.+\/)?([^/.]+)/);
                    if (match && match[1]) { bgSource = 'https://res.cloudinary.com/' + CLOUDINARY_CONFIG.cloudName + '/video/upload/so_0,eo_3,w_400,h_225,c_fill,f_gif/' + match[1] + '.gif'; isGif = true; }
                }
                
                // أزرار المشرف (مع إضافة زر حذف الامتحان)
                const adminButtons = isAdmin ? `
                    <button class="delete-btn" onclick="event.stopPropagation(); deleteVideo('${video.id}', '${video.publicId || ''}')">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    <button class="edit-title-btn" onclick="event.stopPropagation(); editVideoTitle('${video.id}')" title="تعديل العنوان والوصف">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button class="exam-btn" onclick="event.stopPropagation(); openCreateExamModal('${video.id}')" title="إضافة امتحان">
                        <i class="fas fa-clipboard-list"></i> امتحان
                    </button>
                    <button class="delete-exam-btn" onclick="event.stopPropagation(); deleteExam('${video.id}')" title="حذف الامتحان">
                        <i class="fas fa-trash"></i> حذف الامتحان
                    </button>
                ` : '';
                
                // قسم الامتحان: للمشرف يظهر "تصحيح الامتحان"، للطالب "دخول الامتحان"
                const examSection = `
                    <div class="exam-section">
                        ${isAdmin ? `
                            <button class="correction-btn-card" onclick="event.stopPropagation(); openCorrectionPanel('${video.id}')">
                                <i class="fas fa-check-double"></i> تصحيح الامتحان
                            </button>
                        ` : `
                            <button class="exam-btn-card" onclick="event.stopPropagation(); openStudentExamModal('${video.id}')">
                                <i class="fas fa-clipboard-check"></i> دخول الامتحان
                            </button>
                        `}
                    </div>
                `;
                
                return `
                    <div class="video-card" onclick="playVideo('${video.id}')">
                        <div class="video-thumbnail">
                            ${bgSource ? '<img src="' + bgSource + '" alt="' + video.title + '" class="bg-gif" onerror="this.style.display=\'none\'; this.parentNode.querySelector(\'.fallback-icon\').style.display=\'flex\';">' : ''}
                            <div class="fallback-icon" style="display: ${bgSource ? 'none' : 'flex'}; position: absolute; z-index: 2;">
                                <i class="fas fa-film"></i>
                            </div>
                            ${isGif ? '<div class="gif-badge">GIF</div>' : ''}
                            ${duration ? '<div class="video-duration"><i class="fas fa-clock"></i> ' + duration + '</div>' : ''}
                            <div class="play-overlay"><div class="play-btn"><i class="fas fa-play"></i></div></div>
                            ${adminButtons}
                        </div>
                        <div class="video-info">
                            <h4 class="video-title">${video.title} ${video.size > 100 * 1024 * 1024 ? '<span style="color:#ec4899; font-size:0.8rem;"> <i class="fas fa-hd"></i> HD</span>' : ''}</h4>
                            ${video.description ? '<div class="video-description">' + video.description + '</div>' : ''}
                            
                            ${examSection}
                            
                            <div class="video-meta">
                                <span><i class="fas fa-calendar"></i> ${video.createdAt ? new Date(video.createdAt.toDate()).toLocaleDateString('ar-EG') : 'الآن'}</span>
                                <span><i class="fas fa-hdd"></i> ${formatSize(video.size)}</span>
                                ${video.width ? '<span><i class="fas fa-expand"></i> ' + video.width + 'x' + video.height + '</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== دوال الامتحانات المعدلة (بدون تصحيح تلقائي) ==========

        // فتح نافذة إنشاء الامتحان
        function openCreateExamModal(videoId) {
            if (!isAdmin) { showToast('❌ هذه الصلاحية للمشرف فقط'); return; }
            currentExamVideoId = videoId;
            examQuestions = [];
            document.getElementById('examQuestionsContainer').innerHTML = '';
            addQuestionForm();
            document.getElementById('createExamModal').classList.add('active');
        }

        function closeCreateExamModal() {
            document.getElementById('createExamModal').classList.remove('active');
            currentExamVideoId = null;
            examQuestions = [];
        }

        function addQuestionForm() {
            const container = document.getElementById('examQuestionsContainer');
            const questionIndex = examQuestions.length + 1;
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-form';
            questionDiv.id = `question-form-${questionIndex}`;
            questionDiv.innerHTML = `
                <div class="question-header">
                    <span class="question-number">سؤال ${questionIndex}</span>
                    ${questionIndex > 1 ? `<button class="remove-question-btn" onclick="removeQuestion(${questionIndex})"><i class="fas fa-trash"></i></button>` : ''}
                </div>
                <div class="form-group">
                    <label>نص السؤال</label>
                    <input type="text" id="q-text-${questionIndex}" placeholder="اكتب السؤال هنا..." style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-family: 'Cairo';">
                </div>
                <div class="form-group">
                    <label>صورة للسؤال (اختياري)</label>
                    <input type="file" id="q-image-${questionIndex}" accept="image/*" style="display: none;" onchange="previewQuestionImage(${questionIndex}, this)">
                    <button type="button" class="btn btn-ghost" onclick="document.getElementById('q-image-${questionIndex}').click()" style="width: 100%; margin-bottom: 0.5rem;">
                        <i class="fas fa-image"></i> اختيار صورة
                    </button>
                    <img id="q-image-preview-${questionIndex}" style="max-width: 100%; border-radius: 10px; display: none; margin-top: 0.5rem;">
                </div>
                <div class="form-group">
                    <label>الاختيارات (حدد الإجابة الصحيحة)</label>
                    <div class="option-input-group">
                        <input type="radio" name="correct-${questionIndex}" value="0" class="option-radio" checked>
                        <input type="text" id="q-opt-${questionIndex}-0" placeholder="الاختيار الأول" style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-family: 'Cairo';">
                    </div>
                    <div class="option-input-group">
                        <input type="radio" name="correct-${questionIndex}" value="1" class="option-radio">
                        <input type="text" id="q-opt-${questionIndex}-1" placeholder="الاختيار الثاني" style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-family: 'Cairo';">
                    </div>
                    <div class="option-input-group">
                        <input type="radio" name="correct-${questionIndex}" value="2" class="option-radio">
                        <input type="text" id="q-opt-${questionIndex}-2" placeholder="الاختيار الثالث" style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-family: 'Cairo';">
                    </div>
                    <div class="option-input-group">
                        <input type="radio" name="correct-${questionIndex}" value="3" class="option-radio">
                        <input type="text" id="q-opt-${questionIndex}-3" placeholder="الاختيار الرابع" style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-family: 'Cairo';">
                    </div>
                </div>
            `;
            container.appendChild(questionDiv);
            examQuestions.push(questionIndex);
        }

        function previewQuestionImage(index, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) { 
                    document.getElementById(`q-image-preview-${index}`).src = e.target.result; 
                    document.getElementById(`q-image-preview-${index}`).style.display = 'block'; 
                };
                reader.readAsDataURL(file);
            }
        }

        function removeQuestion(index) {
            const element = document.getElementById(`question-form-${index}`);
            if (element) { 
                element.remove(); 
                examQuestions = examQuestions.filter(q => q !== index); 
            }
            const forms = document.querySelectorAll('.question-form');
            forms.forEach((form, idx) => { 
                form.querySelector('.question-number').textContent = `سؤال ${idx + 1}`; 
            });
        }

        async function saveExam() {
            if (!currentExamVideoId) return;
            const questions = [];
            const forms = document.querySelectorAll('.question-form');
            for (let i = 0; i < forms.length; i++) {
                const form = forms[i];
                const questionNum = i + 1;
                const text = form.querySelector(`#q-text-${examQuestions[i]}`).value.trim();
                if (!text) { showToast(`⚠️ أدخل نص السؤال ${questionNum}`); return; }
                const options = [];
                for (let j = 0; j < 4; j++) {
                    const optText = form.querySelector(`#q-opt-${examQuestions[i]}-${j}`).value.trim();
                    if (!optText) { showToast(`⚠️ أدخل جميع الاختيارات للسؤال ${questionNum}`); return; }
                    options.push(optText);
                }
                const correctIndex = parseInt(form.querySelector(`input[name="correct-${examQuestions[i]}"]:checked`).value);
                let imageUrl = null;
                const imageInput = form.querySelector(`#q-image-${examQuestions[i]}`);
                if (imageInput && imageInput.files[0]) {
                    try {
                        const formData = new FormData();
                        formData.append('file', imageInput.files[0]);
                        formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                        formData.append('cloud_name', CLOUDINARY_CONFIG.cloudName);
                        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`, { method: 'POST', body: formData });
                        const data = await res.json();
                        imageUrl = data.secure_url;
                    } catch (err) { console.error('Error uploading question image:', err); }
                }
                questions.push({ 
                    text: text, 
                    options: options, 
                    correctIndex: correctIndex, 
                    imageUrl: imageUrl 
                });
            }
            if (questions.length === 0) { showToast('⚠️ أضف سؤالاً واحداً على الأقل'); return; }
            try {
                await db.collection('exams').doc(currentExamVideoId).set({
                    videoId: currentExamVideoId,
                    questions: questions,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'مشرف'
                });
                SoundEffects.success();
                showToast('✅ تم حفظ الامتحان بنجاح!');
                closeCreateExamModal();
            } catch (err) { console.error('Error saving exam:', err); SoundEffects.error(); showToast('❌ فشل حفظ الامتحان'); }
        }

        async function openStudentExamModal(videoId) {
            try {
                const examDoc = await db.collection('exams').doc(videoId).get();
                if (!examDoc.exists) { showToast('⚠️ لا يوجد امتحان لهذا الفيديو بعد'); return; }
                currentExamData = examDoc.data();
                currentExamVideoId = videoId;
                studentAnswers = {};
                currentQuestionIndex = 0;
                const video = videos.find(v => v.id === videoId);
                document.getElementById('studentExamTitle').textContent = `امتحان: ${video ? video.title : 'الفيديو'}`;
                document.getElementById('studentNameEntry').style.display = 'block';
                document.getElementById('studentExamQuestions').style.display = 'none';
                document.getElementById('studentExamResult').style.display = 'none';
                document.getElementById('studentExamNameInput').value = '';
                document.getElementById('studentExamModal').classList.add('active');
            } catch (err) { console.error('Error loading exam:', err); showToast('❌ فشل تحميل الامتحان'); }
        }

        function closeStudentExamModal() {
            document.getElementById('studentExamModal').classList.remove('active');
            currentExamData = null;
            currentExamVideoId = null;
            studentAnswers = {};
        }

        function startStudentExam() {
            const name = document.getElementById('studentExamNameInput').value.trim();
            if (!name) { showToast('⚠️ أدخل اسمك أولاً'); return; }
            document.getElementById('studentNameEntry').style.display = 'none';
            document.getElementById('studentExamQuestions').style.display = 'block';
            renderExamQuestions();
            updateExamProgress();
        }

        function renderExamQuestions() {
            const container = document.getElementById('examQuestionsList');
            const questions = currentExamData.questions;
            container.innerHTML = questions.map((q, index) => `
                <div class="exam-question" id="question-${index}" style="${index === 0 ? '' : 'display: none;'}">
                    <div class="exam-question-text">${index + 1}. ${q.text}</div>
                    ${q.imageUrl ? `<img src="${q.imageUrl}" class="exam-question-image" alt="صورة السؤال">` : ''}
                    <div class="exam-options">
                        ${q.options.map((opt, optIndex) => `
                            <button class="exam-option-btn" onclick="selectAnswer(${index}, ${optIndex})" id="opt-${index}-${optIndex}">${opt}</button>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            document.getElementById('totalQuestionsNum').textContent = questions.length;
        }

        function selectAnswer(questionIndex, optionIndex) {
            studentAnswers[questionIndex] = optionIndex;
            const buttons = document.querySelectorAll(`#question-${questionIndex} .exam-option-btn`);
            buttons.forEach((btn, idx) => {
                btn.classList.remove('selected');
                if (idx === optionIndex) btn.classList.add('selected');
            });
            if (questionIndex < currentExamData.questions.length - 1) {
                setTimeout(() => showQuestion(questionIndex + 1), 500);
            }
        }

        function showQuestion(index) {
            document.querySelectorAll('.exam-question').forEach((q, i) => { q.style.display = i === index ? 'block' : 'none'; });
            currentQuestionIndex = index;
            updateExamProgress();
        }

        function updateExamProgress() {
            const total = currentExamData.questions.length;
            const current = currentQuestionIndex + 1;
            const percent = (current / total) * 100;
            document.getElementById('currentQuestionNum').textContent = current;
            document.getElementById('examProgressFill').style.width = percent + '%';
        }

        // دالة إرسال الامتحان (بدون حساب درجة)
        async function submitExam() {
            const name = document.getElementById('studentExamNameInput').value.trim();
            const questions = currentExamData.questions;
            const answers = [];
            questions.forEach((q, index) => {
                const studentAnswer = studentAnswers[index];
                answers.push({
                    question: q.text,
                    questionImage: q.imageUrl || null,
                    studentAnswer: studentAnswer !== undefined ? q.options[studentAnswer] : 'لم يتم الإجابة',
                    selectedIndex: studentAnswer,
                    correctAnswer: q.options[q.correctIndex], // نحتفظ بالإجابة الصحيحة للمشرف
                    isCorrect: null // لم نحدد صح/خطأ
                });
            });
            try {
                await db.collection('exam_results').add({
                    videoId: currentExamVideoId,
                    studentName: name,
                    answers: answers,
                    corrected: false,      // لم يتم التصحيح بعد
                    score: null,           // لا توجد درجة
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                SoundEffects.success();
                showExamSubmittedMessage();
            } catch (err) { console.error('Error saving exam:', err); SoundEffects.error(); showToast('❌ فشل إرسال الامتحان'); }
        }

        // دالة عرض رسالة بعد التقديم
        function showExamSubmittedMessage() {
            document.getElementById('studentExamQuestions').style.display = 'none';
            document.getElementById('studentExamResult').style.display = 'block';
            document.getElementById('resultScore').textContent = '⏳';
            document.getElementById('resultScore').style.color = '#f59e0b';
            document.getElementById('resultMessage').textContent = 'تم استلام إجاباتك، بانتظار التصحيح من المشرف.';
            document.getElementById('resultDetails').innerHTML = `
                <div class="result-item">
                    <span>شكراً لك!</span>
                </div>
                <div class="result-item">
                    <span>سيتم إعلامك بالنتيجة فور تصحيحها.</span>
                </div>
            `;
        }

        // ========== دوال التصحيح (للمشرف) ==========
        async function openCorrectionPanel(videoId) {
            if (!isAdmin) return;
            const video = videos.find(v => v.id === videoId);
            const snapshot = await db.collection('exam_results')
                .where('videoId', '==', videoId)
                .orderBy('submittedAt', 'desc')
                .get();
            
            const results = [];
            snapshot.forEach(doc => results.push({ id: doc.id, ...doc.data() }));

            let html = `
                <div style="max-height: 70vh; overflow-y: auto; padding: 1rem;">
                    <h3 style="margin-bottom: 1rem;">تصحيح امتحان: ${video ? video.title : ''}</h3>
                    ${results.length === 0 ? '<p>لا يوجد طلاب تقدموا بعد</p>' : ''}
            `;
            results.forEach(r => {
                const submittedDate = r.submittedAt ? new Date(r.submittedAt.toDate()).toLocaleDateString('ar-EG') : '';
                const corrected = r.corrected ? 'تم التصحيح' : 'بانتظار التصحيح';
                html += `
                    <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-weight: bold;">${escapeHtml(r.studentName)}</span>
                            <span style="color: #888;">${submittedDate}</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>الحالة:</strong> 
                            <span style="color: ${r.corrected ? '#10b981' : '#f59e0b'}">${corrected}</span>
                            ${r.corrected ? ` | الدرجة: <strong style="color: ${r.score >= 80 ? '#10b981' : r.score >= 60 ? '#f59e0b' : '#ef4444'}">${r.score}%</strong>` : ''}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <details>
                                <summary style="cursor: pointer; color: #6366f1;">عرض إجابات الطالب</summary>
                                <div style="margin-top: 0.5rem; padding-right: 1rem;">
                                    ${r.answers.map((a, i) => `
                                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 0.5rem; margin-bottom: 0.5rem;">
                                            <div style="font-weight: 600;">${i+1}. ${a.question}</div>
                                            <div style="color: #aaa;">إجابة الطالب: ${a.studentAnswer}</div>
                                            <div style="color: #10b981;">الإجابة الصحيحة: ${a.correctAnswer}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                        ${!r.corrected ? `
                            <div style="margin-bottom: 1rem;">
                                <label>أدخل الدرجة (من 100):</label>
                                <input type="number" id="grade-${r.id}" min="0" max="100" value="0" style="width: 80px; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid #6366f1; border-radius: 8px; color: white; margin-left: 0.5rem;">
                            </div>
                            <button class="btn btn-success" style="width: 100%;" onclick="submitCorrection('${r.id}')">
                                <i class="fas fa-save"></i> حفظ التصحيح
                            </button>
                        ` : `
                            <button class="btn btn-warning" style="width: 100%;" onclick="reopenCorrection('${r.id}')">
                                <i class="fas fa-undo"></i> إعادة التصحيح
                            </button>
                        `}
                    </div>
                `;
            });
            html += '</div>';

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'correctionModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3><i class="fas fa-check-double" style="color: #f59e0b;"></i> تصحيح الامتحانات</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="modal-body" style="padding: 0;">
                        ${html}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitCorrection(resultId) {
            const gradeInput = document.getElementById(`grade-${resultId}`);
            if (!gradeInput) return;
            const newScore = parseInt(gradeInput.value);
            if (isNaN(newScore) || newScore < 0 || newScore > 100) {
                showToast('❌ الدرجة يجب أن تكون بين 0 و 100');
                return;
            }
            try {
                await db.collection('exam_results').doc(resultId).update({
                    score: newScore,
                    corrected: true,
                    correctedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                SoundEffects.success();
                showToast('✅ تم تصحيح الامتحان');
                document.getElementById('correctionModal').remove();
            } catch (err) {
                console.error(err);
                SoundEffects.error();
                showToast('❌ فشل حفظ التصحيح');
            }
        }

        async function reopenCorrection(resultId) {
            try {
                await db.collection('exam_results').doc(resultId).update({
                    corrected: false,
                    score: null
                });
                showToast('🔄 يمكنك إعادة التصحيح');
                document.getElementById('correctionModal').remove();
            } catch (err) {
                console.error(err);
                SoundEffects.error();
                showToast('❌ فشل إعادة التصحيح');
            }
        }

        // ========== دالة حذف الامتحان ==========
        async function deleteExam(videoId) {
            if (!isAdmin) return;
            if (!confirm('هل أنت متأكد من حذف هذا الامتحان؟ سيتم حذف جميع نتائجه أيضاً.')) return;
            try {
                await db.collection('exams').doc(videoId).delete();
                const results = await db.collection('exam_results').where('videoId', '==', videoId).get();
                const batch = db.batch();
                results.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                SoundEffects.delete();
                showToast('✅ تم حذف الامتحان وجميع نتائجه');
                renderVideos();
            } catch (err) {
                console.error(err);
                SoundEffects.error();
                showToast('❌ فشل حذف الامتحان');
            }
        }

        // ========== دالة البحث عن النتيجة (لطلاب) ==========
        async function searchExamResult() {
            const videoId = document.getElementById('checkResultVideoSelect').value;
            const name = document.getElementById('checkResultNameInput').value.trim();
            const display = document.getElementById('checkResultDisplay');
            if (!videoId || !name) {
                showToast('⚠️ اختر الفيديو وأدخل اسمك');
                return;
            }
            display.style.display = 'block';
            display.innerHTML = '<p style="text-align: center; color: #888;"><i class="fas fa-spinner fa-spin"></i> جاري البحث...</p>';
            try {
                const snapshot = await db.collection('exam_results')
                    .where('videoId', '==', videoId)
                    .orderBy('submittedAt', 'desc')
                    .get();
                
                let found = null;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.studentName.trim().toLowerCase() === name.trim().toLowerCase()) {
                        found = { id: doc.id, ...data };
                    }
                });

                if (!found) {
                    display.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 2rem;">❌ لم يتم العثور على نتيجة بهذا الاسم</p>';
                    return;
                }

                if (!found.corrected || found.score === null) {
                    // لم يتم التصحيح بعد
                    display.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-hourglass-half" style="font-size: 3rem; color: #f59e0b; margin-bottom: 1rem;"></i>
                            <h3 style="color: #f59e0b;">بانتظار التصحيح</h3>
                            <p style="color: #aaa;">لم يتم تصحيح إجاباتك بعد. يرجى التحقق لاحقاً.</p>
                        </div>
                    `;
                } else {
                    // تم التصحيح، نعرض الدرجة
                    const score = found.score;
                    const scoreColor = score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#ef4444';
                    display.innerHTML = `
                        <div class="result-display" style="padding: 0;">
                            <div class="result-score" style="font-size: 3rem; color: ${scoreColor};">${score}%</div>
                            <div class="result-details" style="margin-top: 1rem;">
                                <div class="result-item"><span>التقدير:</span><span style="color: ${scoreColor};">${score >= 80 ? 'ممتاز' : score >= 60 ? 'جيد' : 'راسب'}</span></div>
                                <div class="result-item"><span>تاريخ التصحيح:</span><span>${found.correctedAt ? new Date(found.correctedAt.toDate()).toLocaleDateString('ar-EG') : '-'}</span></div>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error searching result:', err);
                display.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 2rem;">❌ فشل البحث عن النتيجة</p>';
            }
        }

        // ========== باقي الدوال (كما هي من الكود الأصلي مع الحفاظ عليها) ==========
        // ملاحظة: يجب تضمين جميع الدوال الأخرى مثل formatDuration, formatSize, showToast, playVideo, deleteVideo, إلخ.
        // نظراً لضيق المساحة، لم أكررها هنا، ولكن في الملف الفعلي يجب أن تبقى كما هي.
        // سأضع دوالاً مختصرة للضرورة، ولكن في التطبيق الفعلي، انسخ بقية الدوال من الكود الأصلي.

        // دوال مساعدة مختصرة (يجب استكمالها)
        function formatDuration(seconds) {
            if (!seconds) return '';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        function formatSize(bytes) {
            if (!bytes) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }
        function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }

        // ========== صوتيات (مختصرة) ==========
        const SoundEffects = {
            audioContext: null,
            init() { if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)(); },
            send() { this.init(); /* تنفيذ الصوت */ },
            receive() { this.init(); },
            delete() { this.init(); },
            join() { this.init(); },
            error() { this.init(); },
            success() { this.init(); },
            recordStart() { this.init(); },
            recordStop() { this.init(); },
            tick() { this.init(); }
        };

        // ========== بدء تشغيل الواجهات ==========
        function initCloudinaryWidget() { /* كما هي */ }
        function openCloudinaryWidget() { /* كما هي */ }
        function playVideo(id, startTime) { /* كما هي */ }
        function deleteVideo(id, publicId) { /* كما هي */ }
        function showLogin() { document.getElementById('loginModal').classList.add('active'); }
        function closeLogin() { document.getElementById('loginModal').classList.remove('active'); }
        function doLogin() { /* كما هي */ }
        function logout() { /* كما هي */ }
        function openSetAdminsModal() { /* كما هي */ }
        function closeAdminPasswordModal() { /* كما هي */ }
        function verifyAdminPassword() { /* كما هي */ }
        function closeSetAdminsModal() { /* كما هي */ }
        function saveAdminCount() { /* كما هي */ }
        function checkForResume() { /* كما هي */ }
        function resumeWatching() { /* كما هي */ }
        function dismissResume() { /* كما هي */ }
        function setupProgressTracking() { /* كما هي */ }
        function shareCurrentTime() { /* كما هي */ }
        function checkUrlForShare() { /* كما هي */ }
        function loadAIKnowledgeFromFirebase() { /* كما هي */ }
        function renderAIKnowledgeList() { /* كما هي */ }
        function openTeachAICircleModal() { /* كما هي */ }
        function closeTeachAICircleModal() { /* كما هي */ }
        function saveAIKnowledge() { /* كما هي */ }
        function deleteAIKnowledge(id) { /* كما هي */ }
        function openAIChat() { /* كما هي */ }
        function closeAIChat() { /* كما هي */ }
        function sendAIMessage() { /* كما هي */ }
        function handleAIKeyPress(e) { /* كما هي */ }
        function displayAIMessage(text, sender) { /* كما هي */ }
        function getAIResponse(userMessage) { /* كما هي */ }
        function findAIKnowledge(userMessage) { /* كما هي */ }
        function openChat() { /* كما هي */ }
        function saveUserName() { /* كما هي */ }
        function closeChat() { /* كما هي */ }
        function sendSystemMessage(text) { /* كما هي */ }
        function loadMessages() { /* كما هي */ }
        function displayMessage(id, msg) { /* كما هي */ }
        function playVoiceMessage(btn, url, id) { /* كما هي */ }
        function seekVoice(event, slider, id) { /* كما هي */ }
        function deleteMessage(messageId, sender) { /* كما هي */ }
        function sendMessage() { /* كما هي */ }
        function handleKeyPress(e) { /* كما هي */ }
        function sendImage(input) { /* كما هي */ }
        function toggleRecording() { /* كما هي */ }
        function startRecording() { /* كما هي */ }
        function stopRecording() { /* كما هي */ }
        function uploadVoice(blob) { /* كما هي */ }
        function startVoiceCall() { /* كما هي */ }
        function toggleMute() { /* كما هي */ }
        function endCall() { /* كما هي */ }
        function viewImage(url) { /* كما هي */ }
        function closeImageViewer() { /* كما هي */ }
        function scrollToBottom() { /* كما هي */ }
        function initPresenceSystem() { /* كما هي */ }
        function listenToOnlineUsers() { /* كما هي */ }
        function removePresence() { /* كما هي */ }
        function showMaintenanceScreen(message, endTime) { /* كما هي */ }
        function hideMaintenanceScreen() { /* كما هي */ }
        function updateTimerDisplay(distance) { /* كما هي */ }
        function openMaintenanceModal() { /* كما هي */ }
        function closeMaintenanceModal() { /* كما هي */ }
        function startMaintenance() { /* كما هي */ }
        function cancelMaintenance() { /* كما هي */ }
        function updateStorageBar() { /* كما هي */ }
        function closeDescriptionModal() { /* كما هي */ }
        function saveVideoWithDescription() { /* كما هي */ }
        function editVideoTitle(videoId) { /* كما هي */ }
        function closeEditVideoModal() { /* كما هي */ }
        function saveVideoEdit() { /* كما هي */ }
        // ... الخ

        // إغلاق النوافذ عند النقر خارجها
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'videoModal') closeModal();
                else if (e.target.id === 'loginModal') closeLogin();
                else if (e.target.id === 'adminPasswordModal') closeAdminPasswordModal();
                else if (e.target.id === 'setAdminsModal') closeSetAdminsModal();
                else if (e.target.id === 'teachAICircleModal') closeTeachAICircleModal();
                else if (e.target.id === 'descriptionModal') closeDescriptionModal();
                else if (e.target.id === 'editVideoModal') closeEditVideoModal();
                else if (e.target.id === 'chatModal') closeChat();
                else if (e.target.id === 'aiChatModal') closeAIChat();
                else if (e.target.id === 'imageViewer') closeImageViewer();
                else if (e.target.id === 'maintenanceModal') closeMaintenanceModal();
                else if (e.target.id === 'createExamModal') closeCreateExamModal();
                else if (e.target.id === 'studentExamModal') closeStudentExamModal();
                else if (e.target.id === 'examResultsModal') closeExamResultsModal();
                else if (e.target.id === 'checkResultModal') closeCheckResultModal();
            }
        };

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeLogin();
                closeAdminPasswordModal();
                closeSetAdminsModal();
                closeTeachAICircleModal();
                closeDescriptionModal();
                closeEditVideoModal();
                closeChat();
                closeAIChat();
                if (document.getElementById('callModal').classList.contains('active')) endCall();
                closeImageViewer();
                closeMaintenanceModal();
                closeCreateExamModal();
                closeStudentExamModal();
                closeExamResultsModal();
                closeCheckResultModal();
            }
        });
    </script>
</body>
</html>